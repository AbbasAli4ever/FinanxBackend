# Day 13: Journal Entries Module — Completion Summary

**Date:** February 24, 2026
**Module:** Journal Entries (Double-Entry Bookkeeping)
**Status:** COMPLETED

---

## What Was Built

A comprehensive Journal Entries module — the accounting backbone of the system. Every financial event in accounting maps to a journal entry (debits = credits). This module enables manual journal entries for adjustments, corrections, accruals, and any transaction not auto-generated by other modules. Unlike Bills/Invoices (which track payables/receivables), journal entries directly update Chart of Accounts balances using double-entry bookkeeping rules. Inspired by QuickBooks, Xero, Sage, FreshBooks, Wave, and Zoho Books.

---

## Database Changes

### New Enums (2)
| Enum | Values |
|------|--------|
| `JournalEntryStatus` | DRAFT, POSTED, VOID |
| `JournalEntryType` | STANDARD, ADJUSTING, CLOSING, REVERSING, RECURRING |

### New Models (2)
| Model | Fields | Description |
|-------|--------|-------------|
| `JournalEntry` | 30+ fields | Main entry with full lifecycle, recurring, auto-reversing |
| `JournalEntryLine` | 9 fields | Debit/credit lines linked to accounts |

### Relation Updates (4 existing models)
- Company → `journalEntries[]`
- User → `journalEntriesCreated[]`, `journalEntriesPosted[]`
- Account → `journalEntryLines[]`
- JournalEntry → self-relation `reversedFrom` / `reversals[]`

### New Permissions (5)
| Code | Name | Display Order |
|------|------|--------------|
| `journal:view` | View Journal Entries | 65 |
| `journal:create` | Create Journal Entries | 66 |
| `journal:edit` | Edit Journal Entries | 67 |
| `journal:post` | Post Journal Entries | 68 |
| `journal:delete` | Delete Journal Entries | 69 |

**Total permissions: 68**

---

## API Endpoints (13)

### Static Routes
| # | Method | Route | Permission | Description |
|---|--------|-------|------------|-------------|
| 1 | GET | `/journal-entries/summary` | journal:view | Dashboard stats by status |
| 2 | GET | `/journal-entries/next-number` | journal:create | Next JE-XXXX |
| 3 | GET | `/journal-entries/statuses` | journal:view | 3 statuses with metadata |
| 4 | GET | `/journal-entries/entry-types` | journal:view | 5 entry types |

### CRUD
| # | Method | Route | Permission | Description |
|---|--------|-------|------------|-------------|
| 5 | GET | `/journal-entries` | journal:view | List + filters/search/sort/pagination |
| 6 | GET | `/journal-entries/:id` | journal:view | Full detail with lines + account info |
| 7 | POST | `/journal-entries` | journal:create | Create entry (DRAFT) |
| 8 | PATCH | `/journal-entries/:id` | journal:edit | Update draft only |
| 9 | DELETE | `/journal-entries/:id` | journal:delete | Delete draft only |

### Lifecycle Actions
| # | Method | Route | Permission | Description |
|---|--------|-------|------------|-------------|
| 10 | POST | `/journal-entries/:id/post` | journal:post | DRAFT → POSTED (updates balances) |
| 11 | POST | `/journal-entries/:id/void` | journal:post | POSTED → VOID (reverses balances) |
| 12 | POST | `/journal-entries/:id/reverse` | journal:create | Create new DRAFT with flipped lines |
| 13 | POST | `/journal-entries/:id/duplicate` | journal:create | Clone entry as new DRAFT |

---

## Status Workflow

```
DRAFT --post--> POSTED --void--> VOID
  |                |
delete          reverse (creates new DRAFT with flipped lines)
  |
 edit
```

---

## Key Features

1. **Double-entry validation**: totalDebit MUST equal totalCredit before posting
2. **Balance updates on post**: Each line updates Account.currentBalance based on normalBalance rules
3. **Balance reversal on void**: Voiding undoes all balance changes atomically
4. **Entry types**: STANDARD, ADJUSTING, CLOSING, REVERSING, RECURRING
5. **Auto-reversing entries**: Post an adjusting entry → auto-creates reversal DRAFT dated on reversalDate
6. **Recurring entries**: Post a recurring entry → auto-creates next DRAFT clone
7. **Entry reversal**: Create a new entry with all debit↔credit flipped, linked via reversedFromId
8. **Entry duplication**: Clone any entry as a new DRAFT
9. **Source linking**: Optional sourceType/sourceId for traceability (future: auto-JEs from invoices/bills)
10. **Auto-numbering**: JE-0001, JE-0002... per company
11. **Immutable posted entries**: Only DRAFT can be edited/deleted; posted entries corrected via reversal

---

## Balance Update Logic

```
For each JournalEntryLine when POSTING:
  if account.normalBalance == "DEBIT":
    account.currentBalance += line.debit - line.credit
  else (CREDIT):
    account.currentBalance += line.credit - line.debit

For VOIDING: reverse the above (subtract instead of add)
```

All balance operations run inside Prisma `$transaction` for atomicity.

---

## Test Results (20/20 Scenarios Passing)

| # | Scenario | Result |
|---|----------|--------|
| 1 | GET next-number → JE-0001 | PASS |
| 2 | GET statuses → 3 statuses | PASS |
| 3 | GET entry-types → 5 types | PASS |
| 4 | POST create simple 2-line entry → DRAFT | PASS |
| 5 | POST create multi-line entry (3 lines, balanced) | PASS |
| 6 | Unbalanced entry rejected at post time | PASS |
| 7 | <2 lines rejected at create time | PASS |
| 8 | Line with both debit AND credit > 0 rejected | PASS |
| 9 | PATCH update draft (change amounts, add line) | PASS |
| 10 | POST post → POSTED, account balances updated correctly | PASS |
| 11 | Cannot edit posted entry | PASS |
| 12 | Cannot delete posted entry | PASS |
| 13 | Void posted → VOID, balances reversed to 0 | PASS |
| 14 | Cannot void already voided entry | PASS |
| 15 | Reverse posted → new DRAFT with flipped debit/credit | PASS |
| 16 | Duplicate entry → new DRAFT clone | PASS |
| 17 | DELETE draft entry | PASS |
| 18 | GET summary → correct counts/amounts | PASS |
| 19 | Search/filter/pagination (status, type, search) | PASS |
| 20 | Auto-reversing: post with isAutoReversing → auto-creates reversal DRAFT | PASS |

---

## Files Created (8)

| File | Lines | Purpose |
|------|-------|---------|
| `src/modules/journal-entries/constants/journal-entry-statuses.constant.ts` | ~38 | Status metadata |
| `src/modules/journal-entries/constants/journal-entry-types.constant.ts` | ~30 | Entry type metadata |
| `src/modules/journal-entries/dto/create-journal-entry.dto.ts` | ~120 | Create DTO + line item DTO |
| `src/modules/journal-entries/dto/update-journal-entry.dto.ts` | ~85 | Update DTO (all optional) |
| `src/modules/journal-entries/dto/query-journal-entries.dto.ts` | ~80 | Filter/search/sort/paginate |
| `src/modules/journal-entries/journal-entries.service.ts` | ~530 | Full business logic with balance updates |
| `src/modules/journal-entries/journal-entries.controller.ts` | ~220 | 13 REST endpoints |
| `src/modules/journal-entries/journal-entries.module.ts` | ~12 | Module definition |

## Files Modified (3)

| File | Change |
|------|--------|
| `prisma/schema.prisma` | +2 enums, +2 models, relation updates on 4 models |
| `prisma/seed.ts` | +5 permissions (journal:view/create/edit/post/delete) |
| `src/app.module.ts` | +JournalEntriesModule import |

---

## Running Totals (After Day 13)

| Metric | Count |
|--------|-------|
| Database Tables | 25 |
| Database Enums | 12 |
| API Endpoints | 100 |
| Permissions | 68 |
| Modules | 14 |
